const fs = require('fs');
// const ytdl = require('@distube/ytdl-core');
const db = require('./dataBase.js')
const ffmpeg = require('fluent-ffmpeg');
const EventEmitter = require('events');
const youtubedl = require('youtube-dl-exec')
// const {Readable} = require('stream');

// const url = process.argv[2];
const videoInBytes = []

const display = (show) =>{
  console.log(show)
}

async function thumbnailDoVideo(url) {
  const info = await ytdl.getInfo(url)
  
  let thumbnailComMaiorResolucao = info.videoDetails.thumbnails.pop()
  
  return thumbnailComMaiorResolucao.url
  
}

const emitter = new EventEmitter()

async function baixarAudioParaBD(url) {
  
  display('iniciando')
  console.time('tempo de execução')
  let bufferDeVideo = Buffer.from([])
  let lastporcentagem = -1
  
  await ytdl(url, {quality : 'highestaudio', filter: 'audioonly'})
  .on('progress', (chunkLength, downloaded, total) => {
    porcentagem = ((downloaded / total) * 100).toFixed(0)
    
    if(porcentagem !== lastporcentagem) {
      
      emitter.emit('progress', porcentagem)
      
      lastporcentagem = porcentagem
    }
  })
  .on('data', (chunk) => {
    bufferDeVideo = Buffer.concat([bufferDeVideo, chunk])
  })
  .on('finish', () => {
    console.timeEnd('tempo de execução')
    display('download finalizado')
    // db.adicionarDados(info.videoDetails.title, url, bufferDeVideo)
    videoInBytes.push(bufferDeVideo)
    // const r = Readable.from(bufferDeVideo)
    // display(videoInBytes)
    // ffmpeg(r).complexFilter([
    //   '[0:a] showwavespic=s=1280x240:colors=white:scale=0.4'
    // ]).save('wave.png')
    
  })
}

// const t = (data) => {
//   display(data)
// }

// function sendProgress() {
// }

// emitter.on('progress', data =>{
//   return data
// })


baixarAudioParaBD(url)


// emitter.on('progress', (data) => {
//     display(data)
//   })


// await ffmpeg(videoBuffer).toFormat('ogg').pipe()
// .on('data', (chunk) => {
  //   oggBuffer = Buffer.concat([oggBuffer, chunk])
  // })
  // .on('end', () =>{
    //   console.log('finalizado')
    //   console.timeEnd('tempo de execução')
    //   console.log(oggBuffer.length / 1024 / 1024)
    // })
    
    // if(fs.existsSync('./myDataBase.db')) {
      //   // console.log('já existe')
      //   // db.acessarDados('COUNT(video_name)')
      //   const dadosAcessados = db.acessarDados(['id', 'video_name'])
      //   // const t = db.acessarDados(['id , video_name'], 'WHERE id <= ((SELECT MAX(id) FROM soundFiles) / 2) ')
      //   // db.acessarDados('blob_file', 'WHERE id = 1')
      //   dadosAcessados.then(itens => {
        //     display(itens)
        //   })
        // }else {
          //   db.criarTabela()
          // }
          
          // if(!fs.existsSync('./myDataBase.db')) {
          //   db.criarTabela()
          // }
          // baixarAudioParaBD()
          
module.exports = {
  baixarAudioParaBD,
  thumbnailDoVideo,
  videoInBytes,
  display,
  emitter,
  display
}
          